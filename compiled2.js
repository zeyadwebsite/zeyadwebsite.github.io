function Bullet(t){this.alive=!1;var e=t;this.spawn=function(t,e,i){this.x=t,this.y=e,this.speed=i,this.alive=!0},this.draw=function(){return this.context.clearRect(this.x-1,this.y-1,this.width+2,this.height+2),this.y-=this.speed,!!this.isColliding||("bullet"===e&&this.y<=0-this.height||("enemyBullet"===e&&this.y>=this.canvasHeight||("bullet"===e?this.context.drawImage(imageRepository.bullet,this.x,this.y):"enemyBullet"===e&&this.context.drawImage(imageRepository.enemyBullet,this.x,this.y),!1)))},this.clear=function(){this.x=0,this.y=0,this.speed=0,this.alive=!1,this.isColliding=!1}}function Drawable(){this.init=function(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s},this.speed=0,this.canvasWidth=0,this.canvasHeight=0,this.collidableWith="",this.isColliding=!1,this.type="",this.draw=function(){},this.move=function(){},this.isCollidableWith=function(t){return this.collidableWith===t.type}}function Background(){this.speed=1,this.draw=function(){this.y+=this.speed,this.context.drawImage(imageRepository.background,this.x,this.y);var t=this.y-this.canvasHeight;this.context.drawImage(imageRepository.background,this.x,t),this.y>=this.canvasHeight&&(this.y=0)}}function normalWeapon(){this.fireRate=15,this.counter=0;this.fire=function(){game.bulletPool.get(game.ship.x+game.ship.width/2,game.ship.y,{x:0,y:-3}),game.laser.get(),this.counter=0}}function cloneWeapon(){this.fireRate=15,this.counter=0;this.fire=function(){game.bulletPool.get(game.ship.x+6,game.ship.y,{x:0,y:-3}),game.bulletPool.get(game.ship.x+33,game.ship.y,{x:0,y:-3}),game.laser.get(),this.counter=0}}function forkWeapon(){this.fireRate=15,this.counter=0;this.fire=function(){game.bulletPool.get(game.ship.x+game.ship.width/2,game.ship.y,{x:1,y:-3},15),game.bulletPool.get(game.ship.x+game.ship.width/2,game.ship.y,{x:-1,y:-3},-15),game.laser.get(),this.counter=0}}function Enemy(){var t=0;this.alive=!1,this.collidableWith="bullet",this.type="enemy",this.spawn=function(t,e,i){this.x=t,this.y=e,this.speed=i,this.speedX=0,this.speedY=i,this.alive=!0,this.leftEdge=this.x-90,this.rightEdge=this.x+90,this.bottomEdge=this.y+180},this.draw=function(){return this.context.clearRect(this.x-1,this.y,this.width+1,this.height),this.x+=this.speedX,this.y+=this.speedY,this.x<=this.leftEdge?this.speedX=this.speed:this.x>=this.rightEdge+this.width?this.speedX=-this.speed:this.y>=this.bottomEdge&&(this.speed=1.5,this.speedY=0,this.y-=5,this.speedX=-this.speed),this.isColliding?(game.playerScore+=10,game.explosion.get(),!0):(this.context.drawImage(imageRepository.enemy,this.x,this.y),(t=Math.floor(101*Math.random()))/100<.01&&this.fire(),!1)},this.fire=function(){game.enemyBulletPool.get(this.x+this.width/2,this.y+this.height,-2.5)},this.clear=function(){this.x=0,this.y=0,this.speed=0,this.speedX=0,this.speedY=0,this.alive=!1,this.isColliding=!1}}function init(){game.init()}function Game(){this.init=function(){if(this.playerScore=0,this.bgCanvas=document.getElementById("background"),this.shipCanvas=document.getElementById("ship"),this.mainCanvas=document.getElementById("main"),this.restartButton=document.getElementById("restart-button"),this.restartButton.onclick=function(){game.restart()},document.addEventListener("keydown",function(t){!("block"==document.getElementById("game-over").style.display)||32!==t.which&&13!==t.which||game.restart()}),this.bgCanvas.getContext){this.bgContext=this.bgCanvas.getContext("2d"),this.shipContext=this.shipCanvas.getContext("2d"),this.mainContext=this.mainCanvas.getContext("2d"),Background.prototype.context=this.bgContext,Background.prototype.canvasWidth=this.bgCanvas.width,Background.prototype.canvasHeight=this.bgCanvas.height,Ship.prototype.context=this.shipContext,Ship.prototype.canvasWidth=this.shipCanvas.width,Ship.prototype.canvasHeight=this.shipCanvas.height,Bullet.prototype.context=this.mainContext,Bullet.prototype.canvasWidth=this.mainCanvas.width,Bullet.prototype.canvasHeight=this.mainCanvas.height,Enemy.prototype.context=this.mainContext,Enemy.prototype.canvasWidth=this.mainCanvas.width,Enemy.prototype.canvasHeight=this.mainCanvas.height,this.background=new Background,this.background.init(0,0),this.ship=new Ship;var t=this.shipCanvas.width/2-imageRepository.spaceship.width,e=this.shipCanvas.height/4*3+2*imageRepository.spaceship.height;this.ship.init(t,e,imageRepository.spaceship.width,imageRepository.spaceship.height),this.enemyPool=new Pool(30),this.enemyPool.init("enemy"),this.spawnWave();for(var i=imageRepository.enemy.height,s=imageRepository.enemy.width,h=100,n=-i,o=1.5*n,a=1;a<=18;a++)this.enemyPool.get(h,n,2),h+=s+25,a%6==0&&(h=100,n+=o);return this.enemyBulletPool=new Pool(50),this.enemyBulletPool.init("enemyBullet"),this.quadTree=new QuadTree({x:0,y:0,width:this.mainCanvas.width,height:this.mainCanvas.height}),this.laser=new SoundPool(10),this.laser.init("laser"),this.explosion=new SoundPool(20),this.explosion.init("explosion"),this.backgroundAudio=new Audio("sounds/kick_shock.mp3"),this.backgroundAudio.loop=!0,this.backgroundAudio.volume=.25,this.backgroundAudio.load(),this.gameOverAudio=new Audio("sounds/game_over.mp3"),this.gameOverAudio.loop=!0,this.gameOverAudio.volume=.25,this.gameOverAudio.load(),this.checkAudio=window.setInterval(checkReadyState,1e3),!0}return!1},this.spawnWave=function(){for(var t=imageRepository.enemy.height,e=imageRepository.enemy.width,i=100,s=-t,h=1.5*s,n=0;n<=18;n++)this.enemyPool.get(i,s,2),i+=e+25,n%6==0&&(i=100,s+=h)},this.start=function(){this.ship.draw(),this.backgroundAudio.play(),animate()},this.gameOver=function(){this.backgroundAudio.pause(),this.gameOverAudio.currentTime=0,this.gameOverAudio.play(),document.getElementById("game-over").style.display="block"},this.restart=function(){this.gameOverAudio.pause(),document.getElementById("game-over").style.display="none",this.bgContext.clearRect(0,0,this.bgCanvas.width,this.bgCanvas.height),this.shipContext.clearRect(0,0,this.shipCanvas.width,this.shipCanvas.height),this.mainContext.clearRect(0,0,this.mainCanvas.width,this.mainCanvas.height),this.quadTree.clear(),this.background.init(0,0);var t=this.shipCanvas.width/2-imageRepository.spaceship.width,e=this.shipCanvas.height/4*3+2*imageRepository.spaceship.height;this.ship.init(t,e,imageRepository.spaceship.width,imageRepository.spaceship.height),this.enemyPool.init("enemy"),this.spawnWave(),this.enemyBulletPool.init("enemyBullet"),this.playerScore=0,this.backgroundAudio.currentTime=0,this.ship.draw(),this.backgroundAudio.play()}}function animate(){document.getElementById("score").innerHTML=game.playerScore,game.quadTree.clear(),game.quadTree.insert(game.ship),game.quadTree.insert(game.ship.bulletPool.getPool()),game.quadTree.insert(game.enemyPool.getPool()),game.quadTree.insert(game.enemyBulletPool.getPool()),detectCollision(),0===game.enemyPool.getPool().length&&game.spawnWave(),game.ship.alive&&(requestAnimFrame(animate),game.background.draw(),game.ship.move(),game.ship.bulletPool.animate(),game.enemyPool.animate(),game.enemyBulletPool.animate())}function detectCollision(){var t=[];game.quadTree.getAllObjects(t);for(var e=0,i=t.length;e<i;e++)for(game.quadTree.findObjects(obj=[],t[e]),y=0,length=obj.length;y<length;y++)t[e].collidableWith===obj[y].type&&t[e].x<obj[y].x+obj[y].width&&t[e].x+t[e].width>obj[y].x&&t[e].y<obj[y].y+obj[y].height&&t[e].y+t[e].height>obj[y].y&&(t[e].isColliding=!0,obj[y].isColliding=!0)}function checkReadyState(){4===game.gameOverAudio.readyState&&4===game.backgroundAudio.readyState&&(window.clearInterval(game.checkAudio),game.start())}function Pool(t){var e=t,i=[];this.init=function(t){if("bullet"==t)for(h=0;h<e;h++)(n=new Bullet("bullet")).init(0,0,imageRepository.bullet.width,imageRepository.bullet.height),n.collidableWith="enemy",n.type="bullet",i[h]=n;else if("enemy"==t)for(h=0;h<e;h++){var s=new Enemy;s.init(0,0,imageRepository.enemy.width,imageRepository.enemy.height),i[h]=s}else if("enemyBullet"==t)for(var h=0;h<e;h++){var n=new Bullet("enemyBullet");n.init(0,0,imageRepository.enemyBullet.width,imageRepository.enemyBullet.height),n.collidableWith="ship",n.type="enemyBullet",i[h]=n}},this.get=function(t,s,h){i[e-1].alive||(i[e-1].spawn(t,s,h),i.unshift(i.pop()))},this.getTwo=function(t,s,h,n,o,a){i[e-1].alive||i[e-2].alive||(this.get(t,s,h),this.get(n,o,a))},this.getPool=function(){for(var t=[],s=0;s<e;s++)i[s].alive&&t.push(i[s]);return t},this.animate=function(){for(var t=0;t<e&&i[t].alive;t++)i[t].draw()&&(i[t].clear(),i.push(i.splice(t,1)[0]))}}function QuadTree(t,e){this.bounds=t||{x:0,y:0,width:0,height:0};var i=[];this.nodes=[];var s=e||0;this.clear=function(){i=[];for(var t=0;t<this.nodes.length;t++)this.nodes[t].clear();this.nodes=[]},this.getAllObjects=function(t){for(e=0;e<this.nodes.length;e++)this.nodes[e].getAllObjects(t);for(var e=0,s=i.length;e<s;e++)t.push(i[e]);return t},this.findObjects=function(t,e){if(void 0!==e){var s=this.getIndex(e);-1!=s&&this.nodes.length&&this.nodes[s].findObjects(t,e);for(var h=0,n=i.length;h<n;h++)t.push(i[h]);return t}console.log("UNDEFINED OBJECT")},this.insert=function(t){if(void 0!==t)if(t instanceof Array)for(var e=0,h=t.length;e<h;e++)this.insert(t[e]);else if(this.nodes.length&&-1!=(n=this.getIndex(t)))this.nodes[n].insert(t);else if(i.push(t),i.length>10&&s<5){null==this.nodes[0]&&this.split();for(e=0;e<i.length;){var n=this.getIndex(i[e]);-1!=n?this.nodes[n].insert(i.splice(e,1)[0]):e++}}},this.getIndex=function(t){var e=-1,i=this.bounds.x+this.bounds.width/2,s=this.bounds.y+this.bounds.height/2,h=t.y<s&&t.y+t.height<s,n=t.y>s;return t.x<i&&t.x+t.width<i?h?e=1:n&&(e=2):t.x>i&&(h?e=0:n&&(e=3)),e},this.split=function(){var t=this.bounds.width/2|0,e=this.bounds.height/2|0;this.nodes[0]=new QuadTree({x:this.bounds.x+t,y:this.bounds.y,width:t,height:e},s+1),this.nodes[1]=new QuadTree({x:this.bounds.x,y:this.bounds.y,width:t,height:e},s+1),this.nodes[2]=new QuadTree({x:this.bounds.x,y:this.bounds.y+e,width:t,height:e},s+1),this.nodes[3]=new QuadTree({x:this.bounds.x+t,y:this.bounds.y+e,width:t,height:e},s+1)}}function Ship(){this.speed=3,this.bulletPool=new Pool(30),this.bulletPool.init("bullet");var t=0;this.collidableWith="enemyBullet",this.type="ship",this.weapon={},this.init=function(t,e,i,s){this.x=t,this.y=e,this.width=i,this.height=s,this.alive=!0,this.isColliding=!1,this.bulletPool.init("bullet"),this.weapon=normalWeapon},this.draw=function(){this.context.drawImage(imageRepository.spaceship,this.x,this.y)},this.move=function(){this.weapon.counter++,(KEY_STATUS.left||KEY_STATUS.right||KEY_STATUS.down||KEY_STATUS.up)&&(this.context.clearRect(this.x,this.y,this.width,this.height),KEY_STATUS.left?(this.x-=this.speed,this.x<=0&&(this.x=0)):KEY_STATUS.right?(this.x+=this.speed,this.x>=this.canvasWidth-this.width&&(this.x=this.canvasWidth-this.width)):KEY_STATUS.up?(this.y-=this.speed,this.y<=0&&(this.y=0)):KEY_STATUS.down&&(this.y+=this.speed,this.y>=this.canvasHeight-this.height&&(this.y=this.canvasHeight-this.height)),KEY_STATUS.one?this.weapon=normalWeapon:KEY_STATUS.two?this.weapon=cloneWeapon:KEY_STATUS.three?this.weapon=forkWeapon:KEY_STATUS.four&&(this.weapon=branchWeapon),this.isColliding?game.gameOver():this.draw()),KEY_STATUS.space&&this.weapon.counter>=this.weapon.fireRate&&!this.isColliding&&this.weapon.fire(),t=0},this.fire=function(){this.bulletPool.getTwo(this.x+6,this.y,3,this.x+33,this.y,3),game.laser.get()}}function SoundPool(t){var e=t,i=[];this.pool=i;var s=0;this.init=function(t){if("laser"==t)for(s=0;s<e;s++)laser=new Audio("sounds/laser.mp3"),laser.volume=.12,laser.load(),i[s]=laser;else if("explosion"==t)for(var s=0;s<e;s++){var h=new Audio("sounds/explosion.mp3");h.volume=.1,h.load(),i[s]=h}},this.get=function(){(0==i[s].currentTime||i[s].ended)&&i[s].play(),s=(s+1)%e}}Bullet.prototype=new Drawable;var imageRepository=new function(){function t(){++i===e&&window.init()}this.background=new Image,this.spaceship=new Image,this.bullet=new Image,this.enemy=new Image,this.enemyBullet=new Image;var e=5,i=0;this.background.onload=function(){t()},this.spaceship.onload=function(){t()},this.bullet.onload=function(){t()},this.enemy.onload=function(){t()},this.enemyBullet.onload=function(){t()},this.background.src="images/bg.png",this.spaceship.src="images/ship.png",this.bullet.src="images/bullet.png",this.enemy.src="images/enemy.png",this.enemyBullet.src="images/bullet_enemy.png"};Background.prototype=new Drawable;var normalWeapon=new normalWeapon,cloneWeapon=new cloneWeapon,forkWeapon=new forkWeapon;Enemy.prototype=new Drawable;var game=new Game;window.requestAnimFrame=function(t){window.setTimeout(t,10)},KEY_CODES={32:"space",37:"left",38:"up",39:"right",40:"down"},KEY_STATUS={};for(code in KEY_CODES)KEY_STATUS[KEY_CODES[code]]=!1;document.onkeydown=function(t){var e=t.keyCode?t.keyCode:t.charCode;KEY_CODES[e]&&(t.preventDefault(),KEY_STATUS[KEY_CODES[e]]=!0)},document.onkeyup=function(t){var e=t.keyCode?t.keyCode:t.charCode;KEY_CODES[e]&&(t.preventDefault(),KEY_STATUS[KEY_CODES[e]]=!1)},Ship.prototype=new Drawable;